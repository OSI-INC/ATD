# Accounting Transaction Download

Copyright (C) 2023-2024, Haley Hashemi, Open Source Instruments Inc.\
Copyright (C) 2024, Kevan Hashemi, Open Source Instruments Inc.

## Introduction

The Accounting Transaction Download (ATD) program downloads all transactions in
a specified date range from a Quickbooks Online (QBO) company account. The data
file provided by ATD includes the company's general ledger for the specified date
range, as well as separate legers for each QBO class defined in the company
account. Each leger contains all transactions, including journal entries. Any
transaction that has been assigned a class will appear twice: once in the
general leger and once in a class leger.

The ATD process is a web server and website. The web server is the Unix PHP
utility, which start from a terminal. The website is a collection of pages that
make heavy use of hyptertext preprocessing (PHP). The combination of server and
pages is what we call the "ATD server". We communicate with ATD  by connecting
to our ATD server with a web browser. So far as we can tell, any web browser
will do. 

![ATD Process Schematic](Schematic.gif)

The schematic above attempts to show the interactions that take place between
our browser, the ATD server, the QBO server, and the non-QBO server that hosts
the post-authentication redirect.

Once we have connected to the ATD server, we enter two long-term access keys
provided by Intuit to permit ATD to communicate with our QBO account. We
instruct ATD to initiate a log-in to our QBO account. The ATD server redirects
our browser to QBO, where we enter our log-in credentials. Once QBO is satisfied
that we have identified ourselves, QBO redirects our browser to yet another web
page hosted on a non-QBO server. Along with the redirect command, QBO provides
the access token it has granted us following our successful log-in. The non-QBO
server must provide a secure socket layer (SSL) and support PHP. The web page it
hosts is what we call the "post-authentication" redirect.

The post-authentication redirect takes our browser back to the ATD server, and
in doing so provides our ATD server with the access token it needs to retrieve
transactions from our QBO company. We can now instruct ATD to retrieve reports
from QBO, and we can subsequently download these reports to our own hard driver
with our web browser. 


## Registration

Prior to connecting ATD to your QBO company account, we must obtain our company
credentials on QBO and configure the ATD code. We create an Intuit Developer
account. We use the same e-mail address that we use to log in to our QBO
account. In our Intuit Developer account, we navigate to the Dashboard.

In the Dashboard, we select "Create an App", which we would prefer to describe
as "registering and application", because not application is actually created by
the process that follows our selection. We give the name of the application we
want to use with our QBO account, which is ATD. We answer a few questions about
what the application will do. Ours is an "accounting" application. It reads
accounting information but does nothing else. It makes no modifications to the
company accounts.

We will now be able to see the ATD app listed in our dashboard. Click on the ATD
app link and we will be taken to the ATD's entry in our developer account. The
ATD page provides Development and Production tabs, each with their own set of
parameters. The Development environment which contains keys and credentials that
we can use to access information about a "Sandbox Company", which is a fake
company generated by QBO to test API code on. The Production environment is the
one we must use to set up our QBO account for communication with the ATD app.
Before QBO will give us keys and credentials, we must pass through the QBO app
approval process.


## Approval

Click "Keys and Credentials" under the Production tab. A list of to-do items
will pop up. These tasks include verifying email address and completing our
profile. For the terms of service links, use the ATD license link and the
github.com domain name. We will not be distributing this APP on the QBO store,
so the URLs that allow a user to connect or disconnect can be a link to the
GitHub repository. We categorize the app as "Accounting". We complete the app
assessment questionnaire. Once we are done, QBO will either approve or reject
the app. If the app is approved, our Production company keys and credentials
will be provided, and we will be permitted to enter a "Redirect URI", where
"URI" stands for "universal resource identifier". More about the URI below.


## Credentials

Once QBO ATD is approved, we have access to our credentials. This includes the
Client ID, the Client Secret, and the Redirect URI. The Client ID and Client
Secret are keys that identify our app and enable the app to connect to your
online company. The Client ID is the public ID of the app and the Client Secret
is a private identification string. The Redirect URI is a file on a secure
server that QBO will load once we have used our own personal credentials to log
in to the QBO server. We provide two examples of redirect resources: atd_186.php
and atd_local.php. These are PHP files that we can host on a web server that
provides a PHP hypertext preprocessor. When QBO requests the URI, it passes the
access tokens, which it granted us during out login, along with its request. The
redirect URI will extract these tokens, redirects our browser to the local machine
that is running our ATD server, and provides the tokens to that server with the
redirect request. The redirect URI listed in the Production Settings of the App
should match the redirect in the ATD code. Intuit requires that the URI be
hosted on a secure server, that is: it must be an https link, it cannot be an
http link nor a local link within our own network.


## Configuration

We configure ATD with config.php. In this file we specify our redirect URI
and the IP address and port two which we want our ATD process to listen for
connections. We will interact with ATD using a web browser by opening a socket
to the IP address and port that we wpecify in config.php. You are welcome to
use one of the two URIs we have on our own Open Source Instruments Inc. (OSI)
secure server.

https://www.opensourceinstruments.com/HTML/Redirect/atd_186.php

https://www.opensourceinstruments.com/HTML/Redirect/atd_local.php

The default config.php uses the OSI atd_local.php. In the long run, we would
prefer you to host your URI on your own securre server. When you use our URI, it
is possible for us to extract and store your tokens on our own server, which we
don't do, but the fact that it is in principle possible for us to store your
tokens will most certainly violate your company's security protocols. So don't
use our URI any more than you must.

We set the homeURL in config.php. By default this is "localhost:3000". We set
the baseURL in config.php. This determines the type of company the app is
accessing. To access a sandbox company, the string is "development". To access a
production company, the string is "production". 


## Installation

Install php on the ATD server machine, version 8.3 or greater. Clone the ATD 
repository, specifying the repository with the following GitHub link.

https://github.com/OSI-INC/ATD

Start the ATD process on the ATD server by navigating to the ATD directory and
entering one of the following commands in the terminal. 

php -S localhost:3000 

php -S 192.168.1.186:3000

Here we instruct ATD to listen for a connection from the host computer on port
3000, or to listen for a connection to IP address 192.168.186 on port 3000, on
the assumption that this computer is assigned IP address 192.168.1.186.

In your web browser, open a socket to this server by navigating to ip:port.
These could be "localhost:3000" for a "development" deployment of ATD, or
"192.168.1.186:3000" for a "production" deployment. You should see the ATD main
page open in your browser, inviting you to submit your client identifier and
client secret. You can access these in your development or production settings
of your app on QBO.

Click Connect Company button, and log into your account, selecting the company
you'd like to access. Your redirect URI will bring the web server back to the
ATD index page. Fill out report settings and submit them to ATD. Click "Generate
Report" and wait about 20 seconds. Download generated reports. 


## Security

The ATD program never alters anything in our QBO company. Its only function is
to download accounting information from the company.

The ATD process keeps its access keys and tokens in a block of memory reserved
for our current ATD session. It never writes the keys or tokens to disk. There
is no place where we can enter default values for the keys or tokens in the ATD
code. We can instruct our web browser to remember the access keys, so that it is
easy for us to enter them when we start each ATD session. The access keys last
for several months, but eventually we have to renew them by visiting the Intuit
developer website. The access token we obtain after our log-in will last so long
as our session is active, but will be obtained only after we log into QBO using
its full authentication process.


## Comments

The ATD application is currently configured so that the server and client are
both local. The redirect files that are hosted on the OSI website are atd_local.php
and atd_186.php. If we want to host the PHP server on a LAN with the IP address
listed in atd_186, we change the redirect URI, Callback URI and Home URI to
reflect this address and redirect file. If we want to host the PHP server at
another IP address, we must first identify the server's IP address. Use this IP
address for the Callback URI in your redirect file, and for the Home URI in the
callback and report files. The redirect file itself must be also be hosted on a
website, and the address of file will be our new redirect URI.

The ATD application does not use an external package manager. If you want to use
the Composer package manager, change the include ('../config.php') at the top of
each file to the composer autoload function. The include ('../config.php') uses
the autoloader config file that acts as an SQL database query function. This is
a way of loading QBO's functions, classes, variables, etc, that are necessary
for each piece of code. 


