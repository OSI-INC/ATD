Accounting Transaction Download
===============================

Copyright (C) 2023-2024, Haley Hashemi, Open Source Instruments Inc.
Copyright (C) 2024, Kevan Hashemi, Open Source Instruments Inc.

Introduction
------------

The Accounting Transaction Download (ATD) program downloads all transactions in
a specified date range from a Quickbooks Online (QBO) company account. The data
file provided by ATD includes the company's general leger for the specified date
range, as well as a separate leger for each QBO class defined in the company
account. Each leger contains all transactions, including journal entries. Any
transaction that has been assigned a class will appear twice in the data file:
once in the general leger and once in a class leger. To use ATD, we run the ATD
program in a PHP server. We can set up the PHP server on our own computer or
some other computer assigned for the purpose on our local area network. We
connect to the PHP server with a web browser, and we interact with the ATD
program through its browser interface. By means of this interface, we submit the
credentials that permit ATD to access our QBO company account. ATD then directs
us to the QBO log in, using the credentials. We log in to QBO to verify our
assocation with our QBO company account, and we are redirected back to the ATD
interface. We can then generate and download the report.

Note:
----

This code does not use any external package managers, like composer. If you want
to use composer, change the include ('../config.php') at the top of each file to
the composer autoload function. The include('../config.php') uses the autoloader
config file that acts as an SQL database query function. This is a way of
loading QBO's functions, classes, variables, etc, that are necessary for each
piece of code. 

Preliminary Steps
------------------

Prior to connecting ATD to your QBO company account, we must obtain our company
credentials on Quickbooks and configure the ATD code.


Registering ATD 
----------------

1) We create an Intuit Developer account. We use the same e-mail address that we
use to log in to our QBO account.

2) In our Intuit Developer account, we navigate to the Dashboard.

3) We select "Create an App", which is more like "Registering an App". We give the
name of the application and answer a few questions about what it will do. It is
an "accounting" appliucation. We will now be able to see the ATD app listed in
our dashboard. Click on the ATD app link and we will be taken to the ATD's entry
in our developer account.

4) The ATD page provides Development and Production tabs, each with their own
set of parameters. The Development environment which contains keys and
credentials that we can use to access information about a "Sandbox Company",
which is a fake company generated by QBO to test API code on. The
Production environment is the one we must use to set up our QBO account
for communication with the ATD app. Before QBO will give us keys and
credentials, we must pass through the QBO app approval process.


App Aproval Process
-------------------

1) We click "Keys and Credentials" under the Production tab.

2) A list of to-do items will pop up. These tasks include verifying email
address and completing our profile. The more complicated tasks are described
below.

3) Terms of service links: use the ATD license link and the github.com domain
name for these.

4) We will not be distributing this APP on the QBO store, so the URLs that allow
a user to connect or disconnect can be a link to the GitHub repository.

5) We categorize the app as "Accounting".

6) We complete the app assessment questionnaire.

7) QBO will either approve or reject the app. If the app is approved, our
Production company keys and credentials will be provided, and we will be
permitted to enter a "Redirect URI", where "URI" stands for "universal resource
identifier". More about the URI below.


Keys and Credentials
---------------------

Once QBO ATD is approved, we have access to our credentials. This includes the
Client ID, the Client Secret, and the Redirect URI. The Client ID and Client
Secret are keys that identify our app and enable the app to connect to your
online company. The Client ID is the public ID of the app and the Client Secret
is a private identification string. The Redirect URI is a file on a secure
server that QBO will load once we have used our own personal credentials to log
in to the QBO server. We provide two examples of redirect resources: atd_186.php
and atd_local.php. These are PHP files that we can host on a web server that
provides a PHP hypertext preprocessor. When QBO requests the URI, it passes the
security tokens, which it granted us during out login, along with its request. The
redirect URI will extract these tokens, redirects our browser to the local machine
that is running our ATD server, and provides the tokens to that server with the
redirect request. The redirect URI listed in the Production Settings of the App
should match the redirect in the ATD code. Intuit requires that the URI be
hosted on a secure server, that is: it must be an https link, it cannot be an
http link nor a local link within our own network.


ATD Configuration
-----------------

1) We configure ATD with atdconfig.php. In this file we specify our redirect URI
and the IP address and port two which we want our ATD process to listen for
connections. We will interact with ATD using a web browser by opening a socket
to the IP address and port that we wpecify in atdconfig.php. You are welcome to
use one of the two URIs we have on our own Open Source Instruments Inc. (OSI)
secure server.

https://www.opensourceinstruments.com/HTML/Redirect/atd_186.php
https://www.opensourceinstruments.com/HTML/Redirect/atd_local.php

The default atdconfig.php uses the OSI atd_local.php and 

WARNING: In the long run, however, we would prefer you to host your URI on your
own securre server. When you use our URI, it is possible for us to extract and
store your tokens on our own server, which we don't do, but the fact that it is
in principle possible for us to store your tokens will most certainly violate
your company's security protocols. So don't use our URI any more than you must.

2) We set the homeURL in atdconfig.php. By default this is "localhost:3000". 

3) We set the baseURL in atdconfig.php. This determines the type of company the
app is accessing. To access a sandbox company, the string is "development". To
access a production company, the string is "production". 


Flow of steps for ATD connection
--------------------------------

1) Install php, version 8.3 or greater.

2) Start the ATD process on a computer you have selected to act as your ATD
server. This could be your own laptop or a permanent computer in your local area
network. In the ATD directory, enter:

php -S localhost:3000 
php -S 192.168.1.186:3000

Here we instruct ATD to listen for a connection from the host computer on port
3000, or to listen for a connection to IP address 192.168.186 on port 3000, on
the assumption that this computer is assigned IP address 192.168.1.186.

3) In your web browser, open a socket to this server by navigating to <your ip
address>:<port>. This would be "localhost:3000" or :192.168.1.186:3000" when
using the commands listed above.

4) Submit your client ID and client Secret. You can access these in your
Development or Production settings of your app on Quickbooks.

5) Click Connect Company button, and log into your account, selecting the
company you'd like to access. Your redirect URI will bring the web server back
to the ATD index page.

6) Fill out report settings and save them.

7) Click "Generate Report". This will take about 20 seconds.

8) Download generated reports. 


Separating client from server
-----------------------------

ATD is currently configured so that the server and client are both local. The
redirect files that are hosted on the OSI website are atd_local and atd_186. If
we want to host the PHP server on a LAN with the IP address listed in atd_186,
we change the redirect URI, Callback URI and Home URI to reflect this address
and redirect file. If we want to host the PHP server at another IP address, we
must first identify the server's IP address. Use this IP address for the
Callback URI in your redirect file, and for the Home URI in the callback and
report files. The redirect file itself must be also be hosted on a website, and
the address of file will be our new redirect URI.
